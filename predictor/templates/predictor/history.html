<!DOCTYPE html>
<html>
<head>
    <title>Prediction History</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #eee; }
        .delete-btn, .delete-all-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .delete-btn:hover, .delete-all-btn:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <h2>Prediction History</h2>

    <button class="delete-all-btn" onclick="deleteAll()">Delete All</button>
    <br><br>

    <table id="history-table">
        <tr>
            <th>Sq. Footage</th>
            <th>Bedrooms</th>
            <th>Bathrooms</th>
            <th>Predicted Price</th>
            <th>Time</th>
            <th>Action</th>
        </tr>
        {% for record in records %}
        <tr id="row-{{ record.id }}">
            <td>{{ record.square_footage }}</td>
            <td>{{ record.bedrooms }}</td>
            <td>{{ record.bathrooms }}</td>
            <td>â‚¹ {{ record.predicted_price|floatformat:"2" }}</td>
            <td>{{ record.created_at|date:"d M Y H:i" }}</td>
            <td>
                <button class="delete-btn" onclick="deleteEntry('{{ record.id }}')">Delete</button>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6">No records found.</td>
        </tr>
        {% endfor %}
    </table>

    <br>
    <a href="{% url 'predictor:home' %}">Go back</a>

    <script>
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') return decodeURIComponent(value);
            }
        }

        function deleteEntry(id) {
            if (!confirm("Are you sure you want to delete this record?")) return;

            fetch(`/predictor/delete/${id}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById(`row-${id}`).remove();
                } else {
                    alert('Failed to delete record.');
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }

        function deleteAll() {
            if (!confirm("Are you sure you want to delete all records?")) return;

            fetch(`/predictor/delete_all/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById("history-table").innerHTML = `
                        <tr>
                            <th>Sq. Footage</th>
                            <th>Bedrooms</th>
                            <th>Bathrooms</th>
                            <th>Predicted Price</th>
                            <th>Time</th>
                            <th>Action</th>
                        </tr>
                        <tr><td colspan="6">No records found.</td></tr>
                    `;
                } else {
                    alert('Failed to delete all records.');
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
    </script>
</body>
</html>
